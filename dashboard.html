<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Devices Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg-1:#041029;
      --bg-2:#071228;
      --card:#07101a;
      --accent:#06b6d4;
      --muted:#94a3b8;
      --on:#10b981;
      --off:#ef4444;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --gap:12px;
      --fw-semibold:600;
      color-scheme: dark;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      background: linear-gradient(180deg,var(--bg-1) 0%, var(--bg-2) 72%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:16px;
    }

    /* Layout container */
    .wrap{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:18px;
      min-height:calc(100vh - 32px);
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo {
      width:48px; height:48px; border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#3b82f6); display:grid; place-items:center;
      color:#021025; font-weight:700; font-size:18px;
    }
    h1{margin:0;font-size:18px}

    /* Controls */
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .stats {
      display:flex;
      gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
      border:1px solid var(--glass);
      padding:8px;
      border-radius:10px;
      align-items:center;
    }
    .stat{
      min-width:86px; text-align:center; padding:8px 12px; border-radius:8px;
      background:transparent;
    }
    .stat .num{font-size:18px;font-weight:700}
    .stat .lbl{font-size:12px;color:var(--muted)}

    button{
      cursor:pointer;
      border:0;
      padding:10px 14px;
      border-radius:10px;
      font-weight:var(--fw-semibold);
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn-primary{background:linear-gradient(90deg,var(--accent),#3b82f6); color:#051029}
    .btn-ghost{background:transparent;border:1px solid var(--glass); color:var(--muted); padding:10px 12px}

    /* Devices grid */
    main{flex:1; display:flex; flex-direction:column; gap:14px}
    .devices-wrap{display:grid; grid-template-columns: repeat(3, 1fr); gap:var(--gap);}
    .device{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid var(--glass);
      transition:transform .12s, box-shadow .12s;
      min-height:72px;
    }
    .device:active{transform:translateY(1px)}
    .meta{display:flex; flex-direction:column; gap:6px; min-width:0}
    .name{font-weight:700; font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .small{font-size:13px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .toggle-btn{
      min-width:84px;
      padding:10px 12px;
      border-radius:10px;
      font-weight:700;
      color:#fff;
      border:0;
      display:inline-flex; align-items:center; justify-content:center;
      touch-action:manipulation;
      user-select:none;
    }
    .on{ background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06)); color:var(--on); border:1px solid rgba(16,185,129,0.12) }
    .off{ background:linear-gradient(90deg, rgba(239,68,68,0.06), rgba(239,68,68,0.03)); color:var(--off); border:1px solid rgba(239,68,68,0.08) }

    /* Modal */
    .modal-back{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px; background:rgba(1,6,12,0.6); z-index:60 }
    .modal{ width:100%; max-width:480px; background:var(--card); padding:16px; border-radius:12px; border:1px solid var(--glass) }

    /* Footer */
    footer{ color:var(--muted); font-size:13px; text-align:center; padding:8px 0 }

    /* Responsiveness */
    @media (max-width:1100px){
      .devices-wrap{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width:720px){
      header{align-items:flex-start}
      .devices-wrap{ grid-template-columns: 1fr; }
      .controls{ width:100%; justify-content:space-between; }
      .stats{ flex:1; justify-content:space-between; padding:10px }
      .stat{ min-width:72px; padding:8px }
      .logo{ width:44px; height:44px }
      .btn-primary, .btn-ghost{ padding:12px 14px; font-size:15px; border-radius:12px }
    }
    @media (max-width:420px){
      body{ padding:10px }
      .logo{ width:40px; height:40px; font-size:16px }
      .name{font-size:14px}
      .small{font-size:12px}
      .toggle-btn{ min-width:72px; padding:10px }
      .stat .num{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo">DB</div>
        <div>
          <h1>Devices Dashboard</h1>
          <div style="color:var(--muted); font-size:13px">Realtime control & status</div>
        </div>
      </div>

      <div class="controls" role="toolbar" aria-label="Controls">
        <div class="stats" aria-hidden="false">
          <div class="stat"><div class="num" id="totalCount">0</div><div class="lbl">Total</div></div>
          <div class="stat"><div class="num" id="onCount">0</div><div class="lbl">ON</div></div>
          <div class="stat"><div class="num" id="offCount">0</div><div class="lbl">OFF</div></div>
        </div>

        <button id="btnAdd" class="btn-primary" aria-haspopup="dialog">Add Device</button>
        <button id="btnSignOut" class="btn-ghost">Sign Out</button>
      </div>
    </header>

    <main>
      <div id="devicesGrid" class="devices-wrap" aria-live="polite"></div>

      <div class="modal-back" id="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal" role="document">
          <h3 id="modalTitle">Add Device</h3>
          <div style="margin-top:10px">
            <label class="small">Device name</label>
            <input id="devName" type="text" autocomplete="off" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--glass); background:transparent; color:inherit" placeholder="e.g., Living Room Light" />
          </div>
          <div style="margin-top:10px">
            <label class="small">Initial state</label>
            <select id="devState" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--glass); background:transparent; color:inherit">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px">
            <button id="modalCancel" class="btn-ghost">Cancel</button>
            <button id="modalSave" class="btn-primary">Save</button>
          </div>
        </div>
      </div>

      <footer>Realtime updates using Firebase Realtime Database</footer>
    </main>
  </div>

  <script>
    // Replace with your Firebase project config
    const firebaseConfig = {
  apiKey: "AIzaSyBImV4-QroenwecFE2Nk53MeJGQt-aWE2o",
  authDomain: "studio-1263535307-205e6.firebaseapp.com",
  databaseURL: "https://studio-1263535307-205e6-default-rtdb.firebaseio.com",
  projectId: "studio-1263535307-205e6",
  storageBucket: "studio-1263535307-205e6.firebasestorage.app",
  messagingSenderId: "240447378915",
  appId: "1:240447378915:web:a69dc620dab3158851fcd6"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // UI refs
    const devicesGrid = document.getElementById('devicesGrid');
    const totalCountEl = document.getElementById('totalCount');
    const onCountEl = document.getElementById('onCount');
    const offCountEl = document.getElementById('offCount');
    const btnAdd = document.getElementById('btnAdd');
    const btnSignOut = document.getElementById('btnSignOut');

    const modalBack = document.getElementById('modalBack');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');
    const devNameInput = document.getElementById('devName');
    const devStateSelect = document.getElementById('devState');

    let devices = {}; // local snapshot

    // modal helpers
    function openModal(){
      modalBack.style.display = 'flex';
      modalBack.setAttribute('aria-hidden','false');
      devNameInput.value = '';
      devStateSelect.value = 'off';
      setTimeout(()=>devNameInput.focus(),50);
    }
    function closeModal(){
      modalBack.style.display = 'none';
      modalBack.setAttribute('aria-hidden','true');
    }

    btnAdd.addEventListener('click', openModal);
    modalCancel.addEventListener('click', closeModal);
    modalBack.addEventListener('click', (e)=>{ if(e.target===modalBack) closeModal(); });

    // Sign out and redirect
    btnSignOut.onclick = async () => {
      await auth.signOut();
      window.location.href = 'index.html';
    };

    // render single device
    function renderDeviceCard(id, data){
      const el = document.createElement('div');
      el.className = 'device';
      el.dataset.id = id;

      const meta = document.createElement('div');
      meta.className = 'meta';

      const nameEl = document.createElement('div');
      nameEl.className = 'name';
      nameEl.title = data.name || '';
      nameEl.textContent = data.name || ('Device ' + id);

      const infoEl = document.createElement('div');
      infoEl.className = 'small';
      const ts = data.createdAt ? new Date(data.createdAt).toLocaleString() : '';
      infoEl.textContent = (data.state === 'on' ? 'On' : 'Off') + (ts ? ' â€¢ ' + ts : '');

      meta.appendChild(nameEl);
      meta.appendChild(infoEl);

      const btn = document.createElement('button');
      btn.className = 'toggle-btn ' + (data.state === 'on' ? 'on' : 'off');
      btn.textContent = (data.state === 'on' ? 'ON' : 'OFF');
      btn.setAttribute('aria-pressed', data.state === 'on' ? 'true' : 'false');
      btn.onclick = () => toggleDeviceState(id);

      el.appendChild(meta);
      el.appendChild(btn);
      return el;
    }

    // render grid
    function renderDevicesGrid(){
      devicesGrid.innerHTML = '';
      const keys = Object.keys(devices || {});
      // sort by createdAt desc
      keys.sort((a,b) => (devices[b].createdAt || 0) - (devices[a].createdAt || 0));
      for(const id of keys){
        const node = renderDeviceCard(id, devices[id]);
        devicesGrid.appendChild(node);
      }
      updateCounts();
    }

    function updateCounts(){
      const ids = Object.keys(devices || {});
      const total = ids.length;
      const onCount = ids.filter(i => devices[i].state === 'on').length;
      const offCount = total - onCount;
      totalCountEl.textContent = total;
      onCountEl.textContent = onCount;
      offCountEl.textContent = offCount;
    }

    // Toggle state with optimistic UI
    function toggleDeviceState(id){
      if(!devices[id]) return;
      const current = devices[id];
      const next = current.state === 'on' ? 'off' : 'on';
      const updates = { state: next, updatedAt: Date.now() };

      // optimistic update
      devices[id] = Object.assign({}, current, updates);
      renderDevicesGrid();

      db.ref('devices/' + id).update(updates).catch(err=>{
        console.error('Toggle failed', err);
        // reload single node from DB to rollback
        db.ref('devices/' + id).get().then(snap=>{
          if(snap.exists()) {
            devices[id] = snap.val();
            renderDevicesGrid();
          }
        });
      });
    }

    // DB listeners
    const devicesRef = db.ref('devices');
    devicesRef.on('child_added', snap => {
      devices[snap.key] = snap.val();
      renderDevicesGrid();
    });
    devicesRef.on('child_changed', snap => {
      devices[snap.key] = snap.val();
      renderDevicesGrid();
    });
    devicesRef.on('child_removed', snap => {
      delete devices[snap.key];
      renderDevicesGrid();
    });

    // add device
    modalSave.addEventListener('click', async ()=>{
      const name = (devNameInput.value || '').trim();
      const state = devStateSelect.value === 'on' ? 'on' : 'off';
      if(!name){ devNameInput.focus(); return alert('Please enter a device name'); }
      const newRef = db.ref('devices').push();
      const payload = { name, state, createdAt: Date.now(), updatedAt: Date.now() };
      try{
        await newRef.set(payload);
        closeModal();
      }catch(err){
        console.error('Add device failed', err);
        alert('Failed to add device: ' + (err.message || err));
      }
    });

    // initial snapshot in case events missed
    devicesRef.once('value').then(snap=>{
      if(snap.exists()) devices = snap.val() || {}; else devices = {};
      renderDevicesGrid();
    }).catch(err=> console.error('Initial read failed', err));

    // auth guard
    auth.onAuthStateChanged(user => {
      if(!user){
        window.location.href = 'index.html';
      } else {
        // optionally you can verify user role by reading /users/{uid}
      }
    });

    // accessibility: close modal on Esc
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && modalBack.style.display === 'flex') closeModal();
    });
  </script>
</body>
</html>
