<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Devices Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #0b1220;
      --card: #07101a;
      --accent: #06b6d4;
      --muted: #94a3b8;
      --on: #10b981;
      --off: #ef4444;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(180deg,#041029 0%, #071228 70%);
      color:#e6eef8; min-height:100vh; padding:20px;
    }
    .wrap { max-width:1100px; margin:0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
    header h1 { margin:0; font-size:20px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      padding:14px; border-radius:10px;
    }
    .stats { display:flex; gap:12px; }
    .stat { padding:12px 16px; border-radius:8px; min-width:120px; text-align:center; }
    .stat .num { font-size:22px; font-weight:700; margin-bottom:6px; }
    .controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
    button { cursor:pointer; border: none; border-radius:8px; padding:8px 12px; font-weight:600; }
    .btn-primary { background: linear-gradient(90deg,var(--accent), #3b82f6); color:#031026; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }
    #devicesGrid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin-top:16px; }
    .device {
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:10px; border-radius:8px; transition:transform .12s;
    }
    .device:hover { transform: translateY(-4px); }
    .device .meta { display:flex; flex-direction:column; gap:4px; }
    .device .name { font-weight:700; }
    .device .small { color:var(--muted); font-size:13px; }
    .toggle-btn {
      min-width:86px; padding:8px; border-radius:8px; color:white; font-weight:700;
    }
    .on { background: linear-gradient(90deg, rgba(16,185,129,0.14), rgba(16,185,129,0.08)); border:1px solid rgba(16,185,129,0.12); color:var(--on); }
    .off { background: linear-gradient(90deg, rgba(239,68,68,0.08), rgba(239,68,68,0.04)); border:1px solid rgba(239,68,68,0.08); color:var(--off); }
    .device .meta .small .muted { color:var(--muted); }
    /* modal */
    .modal-back { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; padding:20px; }
    .modal { background:var(--card); padding:18px; border-radius:10px; width:100%; max-width:420px; border:1px solid rgba(255,255,255,0.04); }
    input, select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; }
    footer { margin-top:22px; color:var(--muted); font-size:13px; text-align:center; }
    @media (max-width:600px) { header { flex-direction:column; align-items:flex-start; gap:10px; } .controls { margin-left:0; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Devices Dashboard</h1>
      <div class="controls">
        <div id="counts" class="card row stats" style="align-items:center;">
          <div class="stat"><div class="num" id="totalCount">0</div><div class="small">Total</div></div>
          <div class="stat"><div class="num" id="onCount">0</div><div class="small">ON</div></div>
          <div class="stat"><div class="num" id="offCount">0</div><div class="small">OFF</div></div>
        </div>
        <button id="btnAdd" class="btn-primary" style="margin-left:12px;">Add Device</button>
        <button id="btnSignOut" class="btn-ghost">Sign Out</button>
      </div>
    </header>

    <section id="devicesGrid" aria-live="polite"></section>

    <div class="modal-back" id="modalBack">
      <div class="modal card">
        <h3 id="modalTitle">Add Device</h3>
        <div style="margin-top:8px;">
          <label class="small">Device name</label>
          <input id="devName" type="text" placeholder="e.g., Living Room Light" />
        </div>
        <div style="margin-top:8px;">
          <label class="small">Initial state</label>
          <select id="devState">
            <option value="off">Off</option>
            <option value="on">On</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
          <button id="modalCancel" class="btn-ghost">Cancel</button>
          <button id="modalSave" class="btn-primary">Save</button>
        </div>
      </div>
    </div>

    <footer>Realtime updates from Firebase Realtime Database</footer>
  </div>

  <script>
    // Replace with your Firebase project config
    const firebaseConfig = {
  apiKey: "AIzaSyBImV4-QroenwecFE2Nk53MeJGQt-aWE2o",
  authDomain: "studio-1263535307-205e6.firebaseapp.com",
  databaseURL: "https://studio-1263535307-205e6-default-rtdb.firebaseio.com",
  projectId: "studio-1263535307-205e6",
  storageBucket: "studio-1263535307-205e6.firebasestorage.app",
  messagingSenderId: "240447378915",
  appId: "1:240447378915:web:a69dc620dab3158851fcd6"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // UI elements
    const devicesGrid = document.getElementById('devicesGrid');
    const totalCountEl = document.getElementById('totalCount');
    const onCountEl = document.getElementById('onCount');
    const offCountEl = document.getElementById('offCount');
    const btnAdd = document.getElementById('btnAdd');
    const btnSignOut = document.getElementById('btnSignOut');

    const modalBack = document.getElementById('modalBack');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');
    const devNameInput = document.getElementById('devName');
    const devStateSelect = document.getElementById('devState');

    // state
    let devices = {}; // local snapshot mapping id -> data

    // Helpers
    function showModal() { modalBack.style.display = 'flex'; devNameInput.value = ''; devStateSelect.value = 'off'; devNameInput.focus(); }
    function hideModal() { modalBack.style.display = 'none'; }
    modalCancel.onclick = hideModal;
    btnAdd.onclick = showModal;

    // Sign-out button
    btnSignOut.onclick = async () => {
      await auth.signOut();
      // Redirect to login page (adjust file name/path as needed)
      window.location.href = 'index.html';
    };

    // Build device card
    function renderDeviceCard(id, data) {
      // container
      const el = document.createElement('div');
      el.className = 'card device';
      el.dataset.id = id;

      // meta
      const meta = document.createElement('div');
      meta.className = 'meta';
      const nameEl = document.createElement('div');
      nameEl.className = 'name';
      nameEl.textContent = data.name || ('Device ' + id);
      const infoEl = document.createElement('div');
      infoEl.className = 'small muted';
      const stateText = (data.state === 'on') ? 'On' : 'Off';
      infoEl.innerHTML = `${stateText} • ${data.createdAt ? new Date(data.createdAt).toLocaleString() : ''}`;

      meta.appendChild(nameEl);
      meta.appendChild(infoEl);

      // toggle button
      const btn = document.createElement('button');
      btn.className = 'toggle-btn ' + (data.state === 'on' ? 'on' : 'off');
      btn.textContent = (data.state === 'on' ? 'ON' : 'OFF');
      btn.onclick = () => toggleDeviceState(id, data);

      el.appendChild(meta);
      el.appendChild(btn);
      return el;
    }

    // Render all devices grid from local devices map
    function renderDevicesGrid() {
      devicesGrid.innerHTML = '';
      // sort by createdAt descending then name
      const sorted = Object.keys(devices).sort((a,b) => {
        const A = devices[a].createdAt || 0;
        const B = devices[b].createdAt || 0;
        return B - A;
      });
      sorted.forEach(id => {
        const el = renderDeviceCard(id, devices[id]);
        devicesGrid.appendChild(el);
      });
      updateCounts();
    }

    function updateCounts() {
      const ids = Object.keys(devices);
      const total = ids.length;
      const onCount = ids.filter(i => devices[i].state === 'on').length;
      const offCount = total - onCount;
      totalCountEl.textContent = total;
      onCountEl.textContent = onCount;
      offCountEl.textContent = offCount;
    }

    // Toggle device state — flips between 'on' and 'off' and writes to DB
    function toggleDeviceState(id, currentData) {
      const nextState = (currentData.state === 'on') ? 'off' : 'on';
      const updates = {
        state: nextState,
        updatedAt: Date.now()
      };
      // apply optimistic UI update locally
      devices[id] = Object.assign({}, currentData, updates);
      renderDevicesGrid();

      // write to DB
      db.ref('devices/' + id).update(updates).catch(err => {
        console.error('Toggle write failed', err);
        // rollback by reloading snapshot from DB (simple approach)
        db.ref('devices/' + id).get().then(snap => {
          if (snap.exists()) devices[id] = snap.val();
          renderDevicesGrid();
        });
      });
    }

    // Listen for devices changes in DB
    const devicesRef = db.ref('devices');
    devicesRef.on('child_added', snapshot => {
      devices[snapshot.key] = snapshot.val();
      renderDevicesGrid();
    });
    devicesRef.on('child_changed', snapshot => {
      devices[snapshot.key] = snapshot.val();
      renderDevicesGrid();
    });
    devicesRef.on('child_removed', snapshot => {
      delete devices[snapshot.key];
      renderDevicesGrid();
    });

    // Create a new device on Save
    modalSave.onclick = async () => {
      const name = (devNameInput.value || '').trim();
      const state = devStateSelect.value === 'on' ? 'on' : 'off';
      if (!name) {
        alert('Please enter a device name');
        return;
      }
      // push new device with metadata
      const newRef = db.ref('devices').push();
      const payload = {
        name: name,
        state: state,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      try {
        await newRef.set(payload);
        hideModal();
      } catch (err) {
        console.error('Failed to add device', err);
        alert('Failed to add device: ' + err.message);
      }
    };

    // Auth guard: redirect to login if not signed in; otherwise load user
    auth.onAuthStateChanged(user => {
      if (!user) {
        // no user, redirect to login (adjust path if needed)
        window.location.href = 'index.html';
        return;
      }
      // optionally show user info or check role
      // e.g., read /users/{uid} to check role if needed
      // db.ref('users/' + user.uid).get().then(s=>{ console.log(s.val()); });
    });

    // Initial fetch (in case child_added events missed)
    devicesRef.once('value').then(snap => {
      if (snap.exists()) {
        devices = snap.val() || {};
        renderDevicesGrid();
      } else {
        devices = {};
        renderDevicesGrid();
      }
    }).catch(err => console.error('Initial devices read failed', err));

  </script>
</body>
</html>
